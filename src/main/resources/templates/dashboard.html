<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="dashboard-container">
    <h2>Welcome to Dashboard ðŸš€</h2>

    <p>
        Logged in user:
        <b id="username">loading...</b>
    </p>

    <button class="logout-btn" onclick="logout()">Logout</button>

    <div id="message"></div>
</div>

<script>
    // â­ cháº¡y khi má»Ÿ trang
    document.addEventListener("DOMContentLoaded", () => {
        checkAuthAndLoadUser();
    });

    // ===============================
    // âœ… CHECK TOKEN + LOAD USER
    // ===============================
    async function checkAuthAndLoadUser() {
        const token = localStorage.getItem("token");

        // âŒ chÆ°a login
        if (!token) {
            redirectToLogin("You are not logged in");
            return;
        }

        try {
            const res = await fetch("/api/user/me", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            // âŒ token háº¿t háº¡n / sai
            if (res.status === 401 || res.status === 403) {
                localStorage.clear();
                redirectToLogin("Session expired, please loging again.");
                return;
            }

            if (!res.ok) {
                throw new Error("Failed to load user");
            }

            const data = await res.json();
            document.getElementById("username").innerText =
                data.username || "unknown";

        } catch (err) {
            console.error("Load user error:", err);
            redirectToLogin("Authentication error. Redirecting...");
        }
    }

    // ===============================
    // âœ… LOGOUT (JWT way)
    // ===============================
    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("username");

        window.location.replace("/login");
    }

    // ===============================
    // âœ… REDIRECT HELPER
    // ===============================
    function redirectToLogin(message) {
        const msgEl = document.getElementById("message");
        msgEl.style.color = "red";
        msgEl.innerText = message;

        setTimeout(() => {
            window.location.replace("/login");
        }, 1000);
    }
</script>

</body>
</html>